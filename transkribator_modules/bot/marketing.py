import asyncio
import random
from datetime import datetime, timedelta
from transkribator_modules.config import logger
from transkribator_modules.db.database import SessionLocal, UserService

class MarketingManager:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ –∞–∫—Ü–∏–π"""
    
    def __init__(self, bot):
        self.bot = bot
        self.promo_messages = [
            {
                "text": "üéÅ **–ü—è—Ç–Ω–∏—á–Ω–∞—è –∞–∫—Ü–∏—è!** –ü—Ä–æ–º–æ–∫–æ–¥ `FRIDAY30` –¥–∞–µ—Ç —Å–∫–∏–¥–∫—É 30% –Ω–∞ –≤—Å–µ —Ç–∞—Ä–∏—Ñ—ã!\n\n"
                       "üí° –î–µ–π—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ –¥–æ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å—è! –ü–æ—Ç–æ—Ä–æ–ø–∏—Å—å!",
                "day": 4  # –ü—è—Ç–Ω–∏—Ü–∞
            },
            {
                "text": "üöÄ **–ù–æ–≤–∞—è –Ω–µ–¥–µ–ª—è ‚Äî –Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏!** \n\n"
                       "üìà –û–±–Ω–æ–≤–∏ —Ç–∞—Ä–∏—Ñ –∏ –ø–æ–ª—É—á–∏ +25% –±–æ–Ω—É—Å–Ω—ã—Ö –º–∏–Ω—É—Ç –≤ –ø–æ–¥–∞—Ä–æ–∫!\n\n"
                       "‚≠ê /plans ‚Äî —Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ —Ç–∞—Ä–∏—Ñ—ã",
                "day": 0  # –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫
            },
            {
                "text": "üéØ **–°–µ—Ä–µ–¥–∏–Ω–∞ –Ω–µ–¥–µ–ª–∏!** –°–∞–º–æ–µ –≤—Ä–µ–º—è –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏!\n\n"
                       "üíé –ü—Ä–æ–º–æ–∫–æ–¥ `–°–†–ï–î–ê20` ‚Äî —Å–∫–∏–¥–∫–∞ 20% –Ω–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–∞—Ä–∏—Ñ\n\n"
                       "üî• –£—Å–ø–µ–π –¥–æ —á–µ—Ç–≤–µ—Ä–≥–∞!",
                "day": 2  # –°—Ä–µ–¥–∞
            }
        ]
        
        self.limit_reminders = [
            "üîî **–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ:** –£ —Ç–µ–±—è –æ—Å—Ç–∞–ª–æ—Å—å –º–∞–ª–æ –º–∏–Ω—É—Ç –¥–ª—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ!\n\n"
            "üí° –û–±–Ω–æ–≤–∏ —Ç–∞—Ä–∏—Ñ –∏ –ø–æ–ª—É—á–∏ –±–µ–∑–ª–∏–º–∏—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø!",
            
            "‚è∞ **–î—Ä—É–∂–µ—Å–∫–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ:** –¢–≤–æ–π –ª–∏–º–∏—Ç –ø–æ—á—Ç–∏ –∏—Å—á–µ—Ä–ø–∞–Ω!\n\n" 
            "üéÅ –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è —Å–∫–∏–¥–∫–∞ 15% –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–µ–≥–æ–¥–Ω—è!",
            
            "üì¢ **–ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ:** –£ —Ç–µ–±—è –æ—Å—Ç–∞–ª–∏—Å—å —Å—á–∏—Ç–∞–Ω–Ω—ã–µ –º–∏–Ω—É—Ç—ã!\n\n"
            "üöÄ –û–±–Ω–æ–≤–∏—Å—å —Å–µ–π—á–∞—Å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä–æ–≤–∞—Ç—å –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π!"
        ]
    
    async def send_daily_promo(self):
        """(–û—Ç–∫–ª—é—á–µ–Ω–æ) –†–∞–Ω–µ–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–æ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –ø—Ä–æ–º–æ-—Å–æ–æ–±—â–µ–Ω–∏—è. –¢–µ–ø–µ—Ä—å –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è."""
        logger.info("send_daily_promo –≤—ã–∑–≤–∞–Ω, –Ω–æ —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞ –∏ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ—Ç.")
        return
    
    async def send_limit_reminder(self, user_telegram_id, remaining_minutes):
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –ª–∏–º–∏—Ç–∞—Ö"""
        try:
            if remaining_minutes <= 5:  # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ª–∏–º–∏—Ç
                message = self.limit_reminders[2]
            elif remaining_minutes <= 15:  # –ù–∏–∑–∫–∏–π –ª–∏–º–∏—Ç
                message = self.limit_reminders[1]
            else:  # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
                message = self.limit_reminders[0]
            
            await self.bot.send_message(
                chat_id=user_telegram_id,
                text=message,
                parse_mode='Markdown'
            )
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –ª–∏–º–∏—Ç–µ: {e}")
    
    async def send_monthly_reset_notification(self):
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–±—Ä–æ—Å–µ –º–µ—Å—è—á–Ω—ã—Ö –ª–∏–º–∏—Ç–æ–≤"""
        try:
            message = """üéâ **–õ–∏–º–∏—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã!**

üîÑ –ù–∞—á–∞–ª—Å—è –Ω–æ–≤—ã–π –º–µ—Å—è—Ü ‚Äî —Ç–≤–æ–∏ –ª–∏–º–∏—Ç—ã —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!

üìä **–ß—Ç–æ —Ç–µ–±—è –∂–¥–µ—Ç:**
‚Ä¢ –ü–æ–ª–Ω—ã–π –º–µ—Å—è—á–Ω—ã–π –ª–∏–º–∏—Ç –º–∏–Ω—É—Ç
‚Ä¢ –ù–æ–≤—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã –∏ –∞–∫—Ü–∏–∏
‚Ä¢ –£–ª—É—á—à–µ–Ω–∏—è –≤ —Ä–∞–±–æ—Ç–µ –±–æ—Ç–∞

üöÄ **–ì–æ—Ç–æ–≤ –∫ –Ω–æ–≤—ã–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è–º?** –û—Ç–ø—Ä–∞–≤–ª—è–π –≤–∏–¥–µ–æ –∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä—É–π –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π!

üêæ *—Ä–∞–¥–æ—Å—Ç–Ω–æ –º—É—Ä—á–∏—Ç –∏ –º–∞—à–µ—Ç —Ö–≤–æ—Å—Ç–∏–∫–æ–º*"""

            db = SessionLocal()
            try:
                user_service = UserService(db)
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º–∏ —Ç–∞—Ä–∏—Ñ–∞–º–∏
                users_with_limits = user_service.get_users_with_limits()
                
                sent_count = 0
                for user in users_with_limits:
                    try:
                        await self.bot.send_message(
                            chat_id=user.telegram_id,
                            text=message,
                            parse_mode='Markdown'
                        )
                        sent_count += 1
                        await asyncio.sleep(0.1)
                        
                    except Exception as e:
                        logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–±—Ä–æ—Å–µ {user.telegram_id}: {e}")
                        continue
                
                logger.info(f"üîÑ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ {sent_count} —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ —Å–±—Ä–æ—Å–µ –ª–∏–º–∏—Ç–æ–≤")
                
            finally:
                db.close()
                
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ send_monthly_reset_notification: {e}")
    
    async def send_welcome_series(self, user_telegram_id, day_number):
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–µ—Ä–∏—é –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–æ–≤—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º"""
        welcome_series = {
            1: """üëã **–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ CyberKitty!**

–°–ø–∞—Å–∏–±–æ –∑–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é! –Ø –ø–æ–º–æ–≥—É —Ç–µ–±–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ—Ç–∞.

üéØ **–°–µ–≥–æ–¥–Ω—è—à–Ω–∏–π —Å–æ–≤–µ—Ç:** –ü–æ–ø—Ä–æ–±—É–π —Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∏–¥–µ–æ ‚Äî –æ–±—ã—á–Ω—É—é —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é –∏ —Å –ò–ò-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º. –†–∞–∑–Ω–∏—Ü–∞ –≤–ø–µ—á–∞—Ç–ª—è–µ—Ç!

üí° –ï—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã? –ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ /help""",
            
            3: """üöÄ **–î–µ–Ω—å 3: –û—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏**

–ó–Ω–∞–µ—à—å –ª–∏ —Ç—ã, —á—Ç–æ –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–∞–º–º–∞—Ä–∏ –≤–∏–¥–µ–æ?

üìã –ü–æ—Å–ª–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏ –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫–∏ "–ö—Ä–∞—Ç–∫–æ–µ —Å–∞–º–º–∞—Ä–∏" –∏–ª–∏ "–ü–æ–¥—Ä–æ–±–Ω–æ–µ —Å–∞–º–º–∞—Ä–∏" ‚Äî –ø–æ–ª—É—á–∏—à—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑!

üéÅ –ë–æ–Ω—É—Å: –ø—Ä–æ–º–æ–∫–æ–¥ `–ù–û–í–ò–ß–û–ö` –¥–∞—ë—Ç +50% –∫ –ª–∏–º–∏—Ç—É –Ω–∞ –ø–µ—Ä–≤—ã–π –º–µ—Å—è—Ü!""",
            
            7: """üíé **–ù–µ–¥–µ–ª—è —Å CyberKitty: –≤—Ä–µ–º—è –¥–ª—è –∞–ø–≥—Ä–µ–π–¥–∞?**

–ü–æ–∑–¥—Ä–∞–≤–ª—è—é! –¢—ã –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –±–æ—Ç–∞ —É–∂–µ –Ω–µ–¥–µ–ª—é!

üìä **–ü–æ—Å–º–æ—Ç—Ä–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É:** /stats
‚≠ê **–†–∞—Å—Å–º–æ—Ç—Ä–∏ —Ç–∞—Ä–∏—Ñ—ã:** /plans

üî• **–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è —Ç–µ–±—è:** —Å–∫–∏–¥–∫–∞ 25% –Ω–∞ –ª—é–±–æ–π –ø–ª–∞—Ç–Ω—ã–π —Ç–∞—Ä–∏—Ñ —Å –ø—Ä–æ–º–æ–∫–æ–¥–æ–º `–ù–ï–î–ï–õ–Ø25`"""
        }
        
        if day_number in welcome_series:
            try:
                await self.bot.send_message(
                    chat_id=user_telegram_id,
                    text=welcome_series[day_number],
                    parse_mode='Markdown'
                )
                logger.info(f"üì¨ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–µ–Ω—å {day_number} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_telegram_id}")
                
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–π —Å–µ—Ä–∏–∏: {e}")

# –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ (–±—É–¥–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –≤ main)
marketing_manager = None

def initialize_marketing_manager(bot):
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞"""
    global marketing_manager
    marketing_manager = MarketingManager(bot)
    return marketing_manager 