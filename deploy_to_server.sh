#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ CyberKitty Transkribator Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€ got_is_tod
# ÐŸÐµÑ€ÐµÑ…Ð¾Ð´ Ñ Pyrogram Ð½Ð° Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Bot API Server

set -e

echo "ðŸš€ CyberKitty Transkribator - Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€"
echo "====================================================="

# ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ ÑÐµÑ€Ð²ÐµÑ€Ð°
SERVER_HOST="got_is_tod"
SERVER_USER="root"
PROJECT_DIR="/opt/cyberkitty-transkribator"
BACKUP_DIR="/opt/cyberkitty-transkribator-backup-$(date +%Y%m%d_%H%M%S)"

# Ð¦Ð²ÐµÑ‚Ð° Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_step() {
    echo -e "${BLUE}ðŸ“‹ $1${NC}"
}

print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº ÑÐµÑ€Ð²ÐµÑ€Ñƒ
check_server_connection() {
    print_step "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÑŽ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº ÑÐµÑ€Ð²ÐµÑ€Ñƒ $SERVER_HOST..."
    
    if ssh -o ConnectTimeout=10 "$SERVER_USER@$SERVER_HOST" "echo 'ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾'" >/dev/null 2>&1; then
        print_success "ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº ÑÐµÑ€Ð²ÐµÑ€Ñƒ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾"
    else
        print_error "ÐÐµ ÑƒÐ´Ð°ÐµÑ‚ÑÑ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ Ðº ÑÐµÑ€Ð²ÐµÑ€Ñƒ $SERVER_HOST"
        echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ:"
        echo "  - SSH ÐºÐ»ÑŽÑ‡Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ñ‹"
        echo "  - Ð¡ÐµÑ€Ð²ÐµÑ€ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½"
        echo "  - Ð˜Ð¼Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾"
        exit 1
    fi
}

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½Ð¾Ð¹ ÐºÐ¾Ð¿Ð¸Ð¸
create_backup() {
    print_step "Ð¡Ð¾Ð·Ð´Ð°ÑŽ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½ÑƒÑŽ ÐºÐ¾Ð¿Ð¸ÑŽ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ Ð²ÐµÑ€ÑÐ¸Ð¸..."
    
    ssh "$SERVER_USER@$SERVER_HOST" "
        if [ -d '$PROJECT_DIR' ]; then
            echo 'Ð¡Ð¾Ð·Ð´Ð°ÑŽ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½ÑƒÑŽ ÐºÐ¾Ð¿Ð¸ÑŽ...'
            cp -r '$PROJECT_DIR' '$BACKUP_DIR'
            echo 'Ð ÐµÐ·ÐµÑ€Ð²Ð½Ð°Ñ ÐºÐ¾Ð¿Ð¸Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð°: $BACKUP_DIR'
        else
            echo 'ÐŸÑ€Ð¾ÐµÐºÑ‚ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½, Ñ€ÐµÐ·ÐµÑ€Ð²Ð½Ð°Ñ ÐºÐ¾Ð¿Ð¸Ñ Ð½Ðµ Ð½ÑƒÐ¶Ð½Ð°'
        fi
    "
    
    print_success "Ð ÐµÐ·ÐµÑ€Ð²Ð½Ð°Ñ ÐºÐ¾Ð¿Ð¸Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð°"
}

# ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÑ‚Ð°Ñ€Ñ‹Ñ… ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²
stop_old_services() {
    print_step "ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÑŽ ÑÑ‚Ð°Ñ€Ñ‹Ðµ ÑÐµÑ€Ð²Ð¸ÑÑ‹..."
    
    ssh "$SERVER_USER@$SERVER_HOST" "
        cd '$PROJECT_DIR' || exit 0
        
        echo 'ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÑŽ Docker ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹...'
        docker-compose down || true
        
        echo 'ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÑŽ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÑ‹ Python...'
        pkill -f 'transkribator' || true
        pkill -f 'pyrogram' || true
        
        echo 'ÐžÑ‡Ð¸Ñ‰Ð°ÑŽ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð¾Ð±Ñ€Ð°Ð·Ñ‹...'
        docker system prune -f || true
    "
    
    print_success "Ð¡Ñ‚Ð°Ñ€Ñ‹Ðµ ÑÐµÑ€Ð²Ð¸ÑÑ‹ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹"
}

# Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð½Ð¾Ð²Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
upload_files() {
    print_step "Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÑŽ Ð½Ð¾Ð²Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€..."
    
    # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ Ð°Ñ€Ñ…Ð¸Ð² Ñ Ð½ÑƒÐ¶Ð½Ñ‹Ð¼Ð¸ Ñ„Ð°Ð¹Ð»Ð°Ð¼Ð¸
    TEMP_ARCHIVE="/tmp/cyberkitty-transkribator-$(date +%Y%m%d_%H%M%S).tar.gz"
    
    print_step "Ð¡Ð¾Ð·Ð´Ð°ÑŽ Ð°Ñ€Ñ…Ð¸Ð² Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°..."
    tar -czf "$TEMP_ARCHIVE" \
        --exclude='.git' \
        --exclude='__pycache__' \
        --exclude='*.pyc' \
        --exclude='.venv' \
        --exclude='node_modules' \
        --exclude='data/bot.log' \
        --exclude='telegram-bot-api-data*' \
        --exclude='downloads' \
        --exclude='videos' \
        --exclude='audio' \
        --exclude='transcriptions' \
        --exclude='archive' \
        .
    
    print_step "Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÑŽ Ð°Ñ€Ñ…Ð¸Ð² Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€..."
    scp "$TEMP_ARCHIVE" "$SERVER_USER@$SERVER_HOST:/tmp/"
    
    # Ð Ð°ÑÐ¿Ð°ÐºÐ¾Ð²Ñ‹Ð²Ð°ÐµÐ¼ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
    ssh "$SERVER_USER@$SERVER_HOST" "
        echo 'Ð¡Ð¾Ð·Ð´Ð°ÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°...'
        mkdir -p '$PROJECT_DIR'
        
        echo 'Ð Ð°ÑÐ¿Ð°ÐºÐ¾Ð²Ñ‹Ð²Ð°ÑŽ Ð°Ñ€Ñ…Ð¸Ð²...'
        cd '$PROJECT_DIR'
        tar -xzf '/tmp/$(basename $TEMP_ARCHIVE)' --strip-components=0
        
        echo 'Ð£Ð´Ð°Ð»ÑÑŽ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ Ð°Ñ€Ñ…Ð¸Ð²...'
        rm '/tmp/$(basename $TEMP_ARCHIVE)'
        
        echo 'Ð¡Ð¾Ð·Ð´Ð°ÑŽ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸...'
        mkdir -p videos audio transcriptions data telegram-bot-api-data
        chmod 755 videos audio transcriptions data telegram-bot-api-data
    "
    
    # Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð°Ñ€Ñ…Ð¸Ð²
    rm "$TEMP_ARCHIVE"
    
    print_success "Ð¤Ð°Ð¹Ð»Ñ‹ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ñ‹ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€"
}

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
setup_environment() {
    print_step "ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÑŽ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ..."
    
    print_warning "ÐÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ .env Ñ„Ð°Ð¹Ð» Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ"
    echo "ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, ÑƒÐºÐ°Ð¶Ð¸Ñ‚Ðµ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ:"
    
    read -p "BOT_TOKEN: " BOT_TOKEN
    read -p "DEEPINFRA_API_KEY: " DEEPINFRA_API_KEY
    read -s -p "TELEGRAM_API_ID (Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ 29612572): " TELEGRAM_API_ID
    echo
    read -s -p "TELEGRAM_API_HASH (Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ fa4d9922f76dea00803d072510ced924): " TELEGRAM_API_HASH
    echo
    
    # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ
    TELEGRAM_API_ID=${TELEGRAM_API_ID:-29612572}
    TELEGRAM_API_HASH=${TELEGRAM_API_HASH:-fa4d9922f76dea00803d072510ced924}
    
    # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env Ñ„Ð°Ð¹Ð» Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
    ssh "$SERVER_USER@$SERVER_HOST" "
        cd '$PROJECT_DIR'
        
        cat > .env << EOF
# CyberKitty Transkribator Configuration
BOT_TOKEN=$BOT_TOKEN
DEEPINFRA_API_KEY=$DEEPINFRA_API_KEY

# Telegram Bot API Server
USE_LOCAL_BOT_API=true
LOCAL_BOT_API_URL=http://telegram-bot-api:8081
TELEGRAM_API_ID=$TELEGRAM_API_ID
TELEGRAM_API_HASH=$TELEGRAM_API_HASH

# Database
DATABASE_URL=sqlite:///./data/cyberkitty-transkribator.db

# Optional APIs
OPENROUTER_API_KEY=
OPENROUTER_MODEL=openai/whisper-large-v3
EOF
        
        echo '.env Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½'
    "
    
    print_success "ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ñ‹"
}

# Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¸ Ð·Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²
build_and_start() {
    print_step "Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÑŽ Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÑŽ ÑÐµÑ€Ð²Ð¸ÑÑ‹..."
    
    ssh "$SERVER_USER@$SERVER_HOST" "
        cd '$PROJECT_DIR'
        
        echo 'Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÑŽ Docker Ð¾Ð±Ñ€Ð°Ð·Ñ‹...'
        docker-compose build
        
        echo 'Ð—Ð°Ð¿ÑƒÑÐºÐ°ÑŽ ÑÐµÑ€Ð²Ð¸ÑÑ‹...'
        docker-compose up -d
        
        echo 'ÐžÐ¶Ð¸Ð´Ð°ÑŽ Ð·Ð°Ð¿ÑƒÑÐºÐ° ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²...'
        sleep 10
        
        echo 'ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÑŽ ÑÑ‚Ð°Ñ‚ÑƒÑ ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²...'
        docker-compose ps
    "
    
    print_success "Ð¡ÐµÑ€Ð²Ð¸ÑÑ‹ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ñ‹"
}

# ÐÐ²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ñ Bot API Server
authorize_bot_api() {
    print_step "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Bot API Server..."
    
    print_warning "Ð”Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ Ð±Ð¾Ð»ÑŒÑˆÐ¸Ð¼Ð¸ Ñ„Ð°Ð¹Ð»Ð°Ð¼Ð¸ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ñ‚ÑŒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð² Bot API Server"
    echo "Ð­Ñ‚Ð¾ Ð¼Ð¾Ð¶Ð½Ð¾ ÑÐ´ÐµÐ»Ð°Ñ‚ÑŒ Ð´Ð²ÑƒÐ¼Ñ ÑÐ¿Ð¾ÑÐ¾Ð±Ð°Ð¼Ð¸:"
    echo "1. Ð˜Ð½Ñ‚ÐµÑ€Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ (Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ)"
    echo "2. Ð¡ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð³Ð¾Ñ‚Ð¾Ð²ÑƒÑŽ ÑÐµÑÑÐ¸ÑŽ Ñ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ð¹ Ð¼Ð°ÑˆÐ¸Ð½Ñ‹"
    echo
    
    read -p "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑÐ¿Ð¾ÑÐ¾Ð± (1/2): " AUTH_METHOD
    
    if [ "$AUTH_METHOD" = "1" ]; then
        print_step "Ð—Ð°Ð¿ÑƒÑÐºÐ°ÑŽ Ð¸Ð½Ñ‚ÐµÑ€Ð°ÐºÑ‚Ð¸Ð²Ð½ÑƒÑŽ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸ÑŽ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ..."
        echo "ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÐµÑÑŒ Ðº ÑÐµÑ€Ð²ÐµÑ€Ñƒ Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ:"
        echo "  ssh $SERVER_USER@$SERVER_HOST"
        echo "  cd $PROJECT_DIR"
        echo "  python3 authorize_bot_api_server.py"
        echo
        read -p "ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ Enter Ð¿Ð¾ÑÐ»Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸..."
        
    elif [ "$AUTH_METHOD" = "2" ]; then
        if [ -d "telegram-bot-api-data-native" ]; then
            print_step "ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÑŽ Ð³Ð¾Ñ‚Ð¾Ð²ÑƒÑŽ ÑÐµÑÑÐ¸ÑŽ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€..."
            scp -r telegram-bot-api-data-native/* "$SERVER_USER@$SERVER_HOST:$PROJECT_DIR/telegram-bot-api-data/"
            print_success "Ð¡ÐµÑÑÐ¸Ñ ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð°"
        else
            print_error "Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ð°Ñ ÑÐµÑÑÐ¸Ñ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð° Ð² telegram-bot-api-data-native/"
            print_warning "Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ ÑÐ¿Ð¾ÑÐ¾Ð± 1 Ð´Ð»Ñ Ð¸Ð½Ñ‚ÐµÑ€Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾Ð¹ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸"
        fi
    else
        print_warning "ÐÐ²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¿Ñ€Ð¾Ð¿ÑƒÑ‰ÐµÐ½Ð°. Ð’Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ ÐµÑ‘ Ð¿Ð¾Ð·Ð¶Ðµ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ."
    fi
}

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€Ð°Ð±Ð¾Ñ‚Ð¾ÑÐ¿Ð¾ÑÐ¾Ð±Ð½Ð¾ÑÑ‚Ð¸
check_health() {
    print_step "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÑŽ Ñ€Ð°Ð±Ð¾Ñ‚Ð¾ÑÐ¿Ð¾ÑÐ¾Ð±Ð½Ð¾ÑÑ‚ÑŒ ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²..."
    
    ssh "$SERVER_USER@$SERVER_HOST" "
        cd '$PROJECT_DIR'
        
        echo 'Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²:'
        docker-compose ps
        
        echo
        echo 'ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Bot API Server:'
        curl -s 'http://localhost:9081/bot$BOT_TOKEN/getMe' | head -100 || echo 'Bot API Server Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½'
        
        echo
        echo 'ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° API ÑÐµÑ€Ð²ÐµÑ€Ð°:'
        curl -s 'http://localhost:9000/health' || echo 'API ÑÐµÑ€Ð²ÐµÑ€ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½'
        
        echo
        echo 'ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð»Ð¾Ð³Ð¸ Ð±Ð¾Ñ‚Ð°:'
        docker-compose logs --tail=10 bot
    "
}

# ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ
main() {
    echo "ÐÐ°Ñ‡Ð¸Ð½Ð°ÑŽ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ CyberKitty Transkribator..."
    echo
    
    check_server_connection
    create_backup
    stop_old_services
    upload_files
    setup_environment
    build_and_start
    authorize_bot_api
    check_health
    
    echo
    print_success "ðŸŽ‰ Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾!"
    echo
    echo "ðŸ“‹ Ð§Ñ‚Ð¾ Ð´Ð°Ð»ÑŒÑˆÐµ:"
    echo "  1. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ Ð±Ð¾Ñ‚Ð° Ð² Telegram"
    echo "  2. ÐŸÑ€Ð¾Ñ‚ÐµÑÑ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÑƒ Ð±Ð¾Ð»ÑŒÑˆÐ¾Ð³Ð¾ Ñ„Ð°Ð¹Ð»Ð°"
    echo "  3. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð»Ð¾Ð³Ð¸: docker-compose logs -f"
    echo
    echo "ðŸ”— ÐŸÐ¾Ð»ÐµÐ·Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ:"
    echo "  cd $PROJECT_DIR"
    echo "  docker-compose ps              # Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²"
    echo "  docker-compose logs -f         # Ð›Ð¾Ð³Ð¸ Ð² Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾Ð¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸"
    echo "  docker-compose restart         # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº"
    echo "  docker-compose down && docker-compose up -d  # ÐŸÐ¾Ð»Ð½Ñ‹Ð¹ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº"
    echo
    echo "ðŸ†˜ Ð’ ÑÐ»ÑƒÑ‡Ð°Ðµ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼:"
    echo "  Ð ÐµÐ·ÐµÑ€Ð²Ð½Ð°Ñ ÐºÐ¾Ð¿Ð¸Ñ: $BACKUP_DIR"
    echo "  Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ: cp -r $BACKUP_DIR/* $PROJECT_DIR/"
}

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð°Ñ€Ð³ÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð²
if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
    echo "Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ: $0 [Ð¾Ð¿Ñ†Ð¸Ð¸]"
    echo
    echo "ÐžÐ¿Ñ†Ð¸Ð¸:"
    echo "  --help, -h     ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑÑ‚Ñƒ ÑÐ¿Ñ€Ð°Ð²ÐºÑƒ"
    echo "  --dry-run      ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ñ‡Ñ‚Ð¾ Ð±ÑƒÐ´ÐµÑ‚ ÑÐ´ÐµÐ»Ð°Ð½Ð¾ Ð±ÐµÐ· Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ"
    echo
    echo "Ð­Ñ‚Ð¾Ñ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ Ð½Ð¾Ð²ÑƒÑŽ Ð²ÐµÑ€ÑÐ¸ÑŽ CyberKitty Transkribator"
    echo "Ñ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¾Ð¹ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Bot API Server Ð²Ð¼ÐµÑÑ‚Ð¾ Pyrogram."
    exit 0
fi

if [ "$1" = "--dry-run" ]; then
    echo "ðŸ§ª Ð Ð•Ð–Ð˜Ðœ Ð¢Ð•Ð¡Ð¢Ð˜Ð ÐžÐ’ÐÐÐ˜Ð¯ - ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð½Ðµ Ð±ÑƒÐ´ÑƒÑ‚ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ñ‹"
    echo
    echo "Ð‘ÑƒÐ´ÐµÑ‚ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¾:"
    echo "  1. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº ÑÐµÑ€Ð²ÐµÑ€Ñƒ $SERVER_HOST"
    echo "  2. Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½Ð¾Ð¹ ÐºÐ¾Ð¿Ð¸Ð¸ Ð² $BACKUP_DIR"
    echo "  3. ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÑ‚Ð°Ñ€Ñ‹Ñ… ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²"
    echo "  4. Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð½Ð¾Ð²Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð² $PROJECT_DIR"
    echo "  5. ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ"
    echo "  6. Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¸ Ð·Ð°Ð¿ÑƒÑÐº Docker ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²"
    echo "  7. ÐÐ²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ñ Bot API Server"
    echo "  8. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€Ð°Ð±Ð¾Ñ‚Ð¾ÑÐ¿Ð¾ÑÐ¾Ð±Ð½Ð¾ÑÑ‚Ð¸"
    exit 0
fi

# Ð—Ð°Ð¿ÑƒÑÐº Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸
main 